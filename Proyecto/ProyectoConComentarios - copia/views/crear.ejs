<%- include("template/cabecera", {tituloWeb: 'Nuevo Estudiante - StudyMatchKey' }) %>

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div id="mensaje-exito" style="display: none;" class="alert alert-success text-center fw-bold shadow-sm mb-4">
                ✅ ¡Estudiante registrado correctamente! Redirigiendo...
            </div>

            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="p-4 text-center" style="background-color: #1a3a5a;">
                    <h2 class="text-white fw-bold mb-0">Crear nuevo Estudiante</h2>
                </div>
                
                <form id="formularioEstudiante" class="p-4 p-md-5 bg-white text-start">
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">Nombre</label>
                        <input type="text" id="nombre" name="nombre" class="form-control border-2 shadow-sm" placeholder="Escribe tu nombre completo">
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Correo electrónico</label>
                        <input type="email" id="email" name="email" class="form-control border-2 shadow-sm" placeholder="Escribe tu email">
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Fecha de nacimiento</label>
                        <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="form-control border-2 shadow-sm">
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Número de móvil</label>
                        <input type="tel" id="telefono" name="telefono" class="form-control border-2 shadow-sm" placeholder="Ej: 600123456" maxlength="9">
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Tipo de Entidad</label>
                        <select id="tipo_entidad" name="tipo_entidad" class="form-select border-2 shadow-sm" required>
                            <option value="">Selecciona...</option>
                            <option value="Colegio">Colegio</option>
                            <option value="Instituto">Instituto</option>
                        </select>
                    </div>

                    <div id="contenedor-modalidad" class="mb-4" style="display: none;">
                        <label class="form-label fw-bold">Modalidad (Bachillerato)</label>
                        <select id="modalidad" name="modalidad" class="form-select border-2 shadow-sm">
                            <option value="Ciencias">Ciencias y Tecnología</option>
                            <option value="Sociales">Humanidades y Ciencias Sociales</option>
                            <option value="Artes">Artes</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Curso</label>
                        <select id="curso" name="curso" class="form-select border-2 shadow-sm" required disabled>
                            <option value="">Primero elige entidad...</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Selecciona las Asignaturas</label>
                        <div id="contenedor-checkboxes" class="p-3 border rounded-3 bg-light shadow-sm" style="max-height: 250px; overflow-y: auto;">
                            <span class="text-muted italic">Primero selecciona un curso...</span>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-bold small">¿Cursas alguna asignatura que no está en la lista?</label>
                            <input type="text" id="asignaturas_extra" class="form-control form-control-sm border-2 shadow-sm" placeholder="Ej: Francés, Teatro, Refuerzo...">
                            <small class="text-muted italic">Si son varias, sepáralas por comas</small>
                        </div>
                        <input type="hidden" id="asignaturas_final" name="asignaturas">
                    </div>

                    <hr class="my-4">

                    <div class="mb-4">
                        <label class="form-label fw-bold">Contraseña</label>
                        <div class="input-group">
                            <input type="password" id="clave" name="clave" class="form-control border-2 border-end-0 shadow-sm" placeholder="Escribe tu contraseña">
                            <span class="input-group-text bg-white border-2 border-start-0" style="cursor: pointer;" onclick="togglePassword('clave', 'ojo-clave')">
                                <i class="bi bi-eye-slash" id="ojo-clave"></i>
                            </span>
                        </div>
                        <div id="requisitos-clave" class="mt-2" style="font-size: 0.85rem; color: #5a7d9a;">
                            <div id="req-mayuscula">● Falta una mayúscula</div>
                            <div id="req-numero">● Falta un número</div>
                            <div id="req-simbolo">● Falta un símbolo (@$!%*?&)</div>
                            <div id="req-longitud">● Mínimo 6 caracteres</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Confirma tu contraseña</label>
                        <div class="input-group">
                            <input type="password" id="clave_confirm" class="form-control border-2 border-end-0 shadow-sm" placeholder="Repite tu contraseña">
                            <span class="input-group-text bg-white border-2 border-start-0" style="cursor: pointer;" onclick="togglePassword('clave_confirm', 'ojo-confirm')">
                                <i class="bi bi-eye-slash" id="ojo-confirm"></i>
                            </span>
                        </div>
                    </div>

                    <button type="submit" id="btnAgregar" class="btn w-100 py-3 fw-bold text-white shadow" disabled style="background-color: #1a3a5a; opacity: 0.5;">
                        Crear cuenta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const datos = {
        "Colegio": {
            "5º Primaria": ["Lengua Castellana", "Matemáticas", "Ciencias Naturaleza", "Ciencias Sociales", "Inglés", "Educación Física", "Religión", "Valores"],
            "6º Primaria": ["Lengua Castellana", "Matemáticas", "Ciencias Naturaleza", "Ciencias Sociales", "Inglés", "Educación Física", "Religión", "Valores Cívicos"]
        },
        "Instituto": {
            "1º ESO": ["Lengua", "Matemáticas", "Inglés", "Biología", "Geografía", "Educación Física", "Música", "Plástica"],
            "2º ESO": ["Lengua", "Matemáticas", "Inglés", "Física y Química", "Geografía", "Educación Física", "Tecnología"],
            "3º ESO": ["Lengua", "Matemáticas", "Inglés", "Biología", "Física y Química", "Geografía", "Educación Física"],
            "4º ESO": ["Lengua", "Inglés", "Geografía", "Matemáticas", "Educación Física", "Biología", "Física", "Economía", "Latín"],
            "1º Bachillerato": {
                "Comunes": ["Lengua I", "Inglés I", "Filosofía", "Educación Física"],
                "Ciencias": ["Matemáticas I", "Biología y Geología", "Física y Química", "Dibujo Técnico I"],
                "Sociales": ["Matemáticas Aplicadas I", "Economía", "Historia Contemporánea"],
                "Artes": ["Dibujo Artístico I", "Cultura Audiovisual", "Volumen"]
            },
            "2º Bachillerato": {
                "Comunes": ["Lengua II", "Inglés II", "Historia de España", "Filosofía II"],
                "Ciencias": ["Matemáticas II", "Biología", "Física", "Química"],
                "Sociales": ["Matemáticas Aplicadas II", "Economía de Empresa", "Geografía"],
                "Artes": ["Dibujo Artístico II", "Diseño", "Cultura Audiovisual II"]
            }
        }
    };

    const hoy = new Date().toISOString().split("T")[0];
    document.getElementById("fecha_nacimiento").setAttribute("max", hoy);

    const entidadSelect = document.getElementById('tipo_entidad');
    const cursoSelect = document.getElementById('curso');
    const modalidadDiv = document.getElementById('contenedor-modalidad');
    const modalidadSelect = document.getElementById('modalidad');
    const contenedorCheckboxes = document.getElementById('contenedor-checkboxes');
    const inputAsignaturasFinal = document.getElementById('asignaturas_final');
    const inputExtra = document.getElementById('asignaturas_extra');

    entidadSelect.addEventListener('change', (e) => {
        const entidad = e.target.value;
        modalidadDiv.style.display = (entidad === 'Instituto') ? 'block' : 'none';
        cursoSelect.innerHTML = '<option value="">Selecciona curso...</option>';
        if (entidad && datos[entidad]) {
            cursoSelect.disabled = false;
            Object.keys(datos[entidad]).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                cursoSelect.appendChild(opt);
            });
        } else { cursoSelect.disabled = true; }
        actualizarSugerencias();
    });

    function actualizarSugerencias() {
        const entidad = entidadSelect.value;
        const curso = cursoSelect.value;
        const modalidad = modalidadSelect.value;
        contenedorCheckboxes.innerHTML = "";
        let listaAsignaturas = [];

        if (entidad === "Instituto" && (curso === "1º Bachillerato" || curso === "2º Bachillerato")) {
            const comunes = datos["Instituto"][curso]["Comunes"];
            const especificas = datos["Instituto"][curso][modalidad] || [];
            listaAsignaturas = [...comunes, ...especificas];
        } else if (entidad && curso && datos[entidad][curso]) {
            listaAsignaturas = datos[entidad][curso];
        }

        if (listaAsignaturas.length > 0) {
            listaAsignaturas.forEach((asig, index) => {
                const div = document.createElement('div');
                div.className = "form-check mb-2";
                div.innerHTML = `<input class="form-check-input check-asignatura" type="checkbox" value="${asig}" id="ch${index}" checked>
                                 <label class="form-check-label" for="ch${index}">${asig}</label>`;
                contenedorCheckboxes.appendChild(div);
            });
            document.querySelectorAll('.check-asignatura').forEach(ch => ch.addEventListener('change', guardarAsignaturasEnString));
        } else {
            contenedorCheckboxes.innerHTML = '<span class="text-muted italic">Selecciona entidad y curso para ver opciones.</span>';
        }
        guardarAsignaturasEnString();
    }

    function guardarAsignaturasEnString() {
        const seleccionadas = Array.from(document.querySelectorAll('.check-asignatura:checked')).map(ch => ch.value);
        const textoExtra = inputExtra.value.trim();
        let resultadoFinal = [...seleccionadas];
        if (textoExtra !== "") {
            const extrasArray = textoExtra.split(',').map(a => a.trim()).filter(a => a !== "");
            resultadoFinal = [...resultadoFinal, ...extrasArray];
        }
        inputAsignaturasFinal.value = resultadoFinal.join(', ');
        validarFormulario();
    }

    cursoSelect.addEventListener('change', actualizarSugerencias);
    modalidadSelect.addEventListener('change', actualizarSugerencias);
    inputExtra.addEventListener('input', guardarAsignaturasEnString);

    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.replace("bi-eye-slash", "bi-eye");
        } else {
            input.type = "password";
            icon.classList.replace("bi-eye", "bi-eye-slash");
        }
    }

    const validarFormulario = () => {
        let esValido = true;
        const clave = document.getElementById('clave').value;
        const claveConfirm = document.getElementById('clave_confirm').value;

        if (document.getElementById('nombre').value.trim().length < 5) esValido = false;
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(document.getElementById('email').value)) esValido = false;
        if (!/^[0-9]{9}$/.test(document.getElementById('telefono').value)) esValido = false;
        if (!document.getElementById('fecha_nacimiento').value) esValido = false;
        if (!entidadSelect.value || !cursoSelect.value) esValido = false;

        const tieneMayus = /[A-Z]/.test(clave);
        const tieneNum = /\d/.test(clave);
        const tieneSimb = /[@$!%*?&]/.test(clave);
        const tieneLong = clave.length >= 6;
        
        document.getElementById('req-mayuscula').style.display = tieneMayus ? 'none' : 'block';
        document.getElementById('req-numero').style.display = tieneNum ? 'none' : 'block';
        document.getElementById('req-simbolo').style.display = tieneSimb ? 'none' : 'block';
        document.getElementById('req-longitud').style.display = tieneLong ? 'none' : 'block';

        if (!(tieneMayus && tieneNum && tieneSimb && tieneLong)) esValido = false;
        if (clave !== claveConfirm || !clave) esValido = false;

        const btn = document.getElementById('btnAgregar');
        btn.disabled = !esValido;
        btn.style.opacity = esValido ? "1" : "0.5";
    };

    document.getElementById('formularioEstudiante').querySelectorAll('input, select').forEach(elem => {
        elem.addEventListener('input', validarFormulario);
        elem.addEventListener('change', validarFormulario);
    });

    document.getElementById('formularioEstudiante').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        try {
            const res = await fetch('/estudiantes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.estado) {
                document.getElementById('mensaje-exito').style.display = 'block';
                window.scrollTo(0,0);
                setTimeout(() => { window.location.href = '/estudiantes/login'; }, 2000);
            }
        } catch (err) { console.error(err); }
    });
</script>



<div class="mt-5 mb-5 text-center">
                <a href="/" class="btn-volver" style="text-decoration: none; color: #5a7d9a; font-weight: bold; border: 2px solid #5a7d9a; padding: 10px 20px;">
                    Volver al Inicio
                </a>
            </div>
        </div>
    </div>
</div>

<%- include("template/cierre") %>