<%- include("template/cabecera", {tituloWeb: 'Mi Panel de Control'}) %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="rounded-pill shadow-sm px-4 py-2" style="background-color: #004085; color: white;">
            <small class="fw-bold">ID ESTUDIANTE: </small>
            <span class="ms-1 fw-bold"><%= estudiante.id_estudiante || '001' %></span>
        </div>
        <a href="/logout" class="text-danger fw-bold text-decoration-none d-flex align-items-center gap-1 small">
             <i class="bi bi-box-arrow-right fs-5"></i> Salir
        </a>
    </div>

    <div class="mb-4">
        <h2 class="fw-bold mb-1" style="color: #1a3a5a;">
            <% if (saludo.includes('Buenos')) { %> ‚òÄÔ∏è 
            <% } else if (saludo.includes('Tardes')) { %> üå§Ô∏è 
            <% } else { %> üåô <% } %>
            <%= saludo %>, <%= estudiante.nombre %>!
        </h2>
        <p class="text-muted small fw-bold text-uppercase mb-0">
            <i class="bi bi-calendar3 me-1"></i>
            <%= new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }) %>
        </p>
    </div>
    
    <div class="p-4 mb-4 rounded-4 shadow-sm" style="background-color: #f8fbff; border-left: 6px solid #0d6efd; position: relative; overflow: hidden;">
        <div class="d-flex align-items-start gap-3">
            <div class="bg-primary rounded-circle p-2 d-flex align-items-center justify-content-center shadow-sm" style="width: 45px; height: 45px;">
                <i class="bi bi-lightning-charge-fill text-white"></i>
            </div>
            <div>
                <p class="mb-1 fw-bold" style="color: #33475b; font-size: 1.15rem; font-style: italic; line-height: 1.4;">
                    "<%= fraseMotivacional %>"
                </p>
                <small class="text-primary text-uppercase fw-bold" style="letter-spacing: 1px; font-size: 0.75rem;">
                    Inspiraci√≥n para tu √©xito acad√©mico
                </small>
            </div>
        </div>
    </div>

    <% if (notificaciones && notificaciones.length > 0) { %>
        <div class="p-4 mb-4 rounded-4 shadow-sm" style="background-color: #f8f9fa; border-left: 6px solid #6c757d;">
            <h6 class="fw-bold text-dark mb-3">
                <i class="bi bi-bell-fill me-2 text-primary"></i> Notificaciones Prioritarias
            </h6>
            <div class="d-grid gap-2">
                <% notificaciones.forEach(notif => { %>
                    <% 
                        let claseAlerta = 'alert-secondary';
                        let icono = 'bi-info-circle-fill';
                        let bordeColor = 'border-secondary';

                        if (notif.tipo === 'examen') { 
                            claseAlerta = 'alert-danger';
                            icono = 'bi-exclamation-octagon-fill';
                            bordeColor = 'border-danger';
                        } else if (notif.tipo === 'entrega') { 
                            claseAlerta = 'alert-primary';
                            icono = 'bi-file-earmark-arrow-up-fill';
                            bordeColor = 'border-primary';
                        } else if (notif.tipo === 'deberes') { 
                            claseAlerta = 'alert-warning text-dark';
                            icono = 'bi-pencil-fill';
                            bordeColor = 'border-warning';
                        }
                    %>
                    <div class="alert <%= claseAlerta %> alert-dismissible fade show p-3 shadow-sm border-start border-4 <%= bordeColor %> mb-0 d-flex align-items-center" role="alert" style="border-radius: 12px;">
                        <i class="bi <%= icono %> me-3 fs-5"></i>
                        <span class="small fw-bold pe-4 text-truncate"><%= notif.texto %></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="font-size: 0.7rem;"></button>
                    </div>
                <% }) %>
            </div>
        </div>
    <% } %>

    <div class="card p-4 shadow-sm border-0 mb-4 bg-white" style="border-radius: 15px;">
        <div class="d-flex justify-content-between mb-2">
            <span class="small fw-bold text-muted">Tu Progreso Semanal</span>
            <span class="small fw-bold text-primary"><%= progreso %>% completado</span>
        </div>
        <div class="progress" style="height: 15px; border-radius: 10px; background-color: #e9ecef;">
            <div id="barraProgreso" class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                 role="progressbar"></div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <div class="card h-100 shadow-sm border-0 bg-white" style="border-radius: 20px; border-left: 5px solid #0d6efd;">
                <div class="card-body d-flex align-items-center p-4">
                    <div class="me-4 d-none d-sm-block">
                        <i class="bi bi-robot fs-1 text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="fw-bold text-dark mb-1">Tutor de Estudio IA</h5>
                        <p class="text-muted small mb-3">Crea materiales personalizados guiados por inteligencia artificial seg√∫n tu m√©todo.</p>
                        <a href="/estudiantes/mi-perfil/asistente" class="btn btn-primary px-4 fw-bold shadow-sm" style="border-radius: 10px;">
                            Comenzar Creaci√≥n
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-white text-center p-3" style="border-radius: 20px;">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-folder-fill fs-2 text-primary mb-2"></i>
                    <h6 class="fw-bold mb-2">Mi Biblioteca</h6>
                    <a href="/estudiantes/mi-perfil/misMateriales" class="btn btn-outline-primary btn-sm fw-bold shadow-sm" style="border-radius: 10px;">
                        Gestionar Archivos
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-center flex-wrap gap-2 mb-5">
        <a href="/estudiantes/mi-perfil/test" class="btn btn-light py-2 px-3 fw-bold shadow-sm rounded-4 small border d-flex align-items-center">
            <i class="bi bi-patch-check me-2 text-primary"></i> Test
        </a>
        <a href="/estudiantes/mi-perfil/mis-metodos" class="btn btn-light py-2 px-3 fw-bold shadow-sm rounded-4 small border d-flex align-items-center">
            <i class="bi bi-journal-bookmark me-2 text-success"></i> M√©todos
        </a>
        <a href="/estudiantes/mi-perfil/calendario" class="btn btn-light py-2 px-3 fw-bold shadow-sm rounded-4 small border d-flex align-items-center">
            <i class="bi bi-calendar-plus me-2 text-warning"></i> Nuevo Evento
        </a>
        <a href="/estudiantes/mi-perfil/mis-eventos" class="btn btn-light py-2 px-3 fw-bold shadow-sm rounded-4 small border d-flex align-items-center">
            <i class="bi bi-list-check me-2 text-info"></i> Mis Eventos
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card p-4 shadow-sm border-0 bg-white mb-5" style="border-radius: 15px;">
                <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary"><i class="bi bi-calendar-week me-2"></i>Agenda de Actividades</h4>
                <div id='calendar'></div> 
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="progresoValor" value="<%= progreso %>">
<input type="hidden" id="tareasData" value='<%- JSON.stringify(estudiante.tareas || []) %>'>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Animaci√≥n Barra de Progreso
        const progreso = document.getElementById('progresoValor').value;
        const barra = document.getElementById('barraProgreso');
        if (barra) { 
            setTimeout(() => { barra.style.width = progreso + "%"; }, 500);
        }

        // 2. FullCalendar
        const tareas = JSON.parse(document.getElementById('tareasData').value);
        const mapaColores = { 'examen': '#dc3545', 'entrega': '#0d6efd', 'deberes': '#ffc107', 'aviso': '#6c757d' };

        const calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                height: 'auto',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
                events: tareas.map(t => ({
                    id: t._id,
                    title: t.completada ? '‚úÖ ' + t.titulo : t.titulo,
                    start: t.fecha.split('T')[0] + 'T' + t.hora,
                    color: t.completada ? '#28a745' : (mapaColores[t.tipo] || '#6c757d'),
                })),
                dateClick: function(info) {
                    window.location.href = `/estudiantes/mi-perfil/calendario?fecha=${info.dateStr}`;
                },
                eventClick: async function(info) {
                    const res = await fetch('/estudiantes/toggle-tarea/' + info.event.id, { method: 'PUT' });
                    const data = await res.json();
                    if (data.estado) location.reload();
                }
            });
            calendar.render();
        }
    });
</script>
<%- include("template/cierre") %>