<%- include("template/cabecera", {tituloWeb: 'Mi Panel de Control'}) %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral" aria-labelledby="menuLateralLabel" style="border-radius: 0 20px 20px 0;">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold text-primary" id="menuLateralLabel">Men√∫ Principal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="d-grid gap-3">
            <a href="/estudiantes/mi-perfil/mis-metodos" class="btn btn-light text-start py-3 px-3 fw-bold shadow-sm rounded-4 border d-flex align-items-center">
                <i class="bi bi-journal-bookmark me-3 text-success fs-5"></i> Mis M√©todos
            </a>
            <a href="/estudiantes/mi-perfil/calendario" class="btn btn-light text-start py-3 px-3 fw-bold shadow-sm rounded-4 border d-flex align-items-center">
                <i class="bi bi-calendar-plus me-3 text-warning fs-5"></i> A√±adir Evento
            </a>
            <a href="/estudiantes/mi-perfil/mis-eventos" class="btn btn-light text-start py-3 px-3 fw-bold shadow-sm rounded-4 border d-flex align-items-center">
                <i class="bi bi-list-check me-3 text-info fs-5"></i> Mis Eventos
            </a>
        </div>
        <div class="mt-5 pt-5 border-top text-center">
            <small class="text-muted">StudyMatch v2.0</small>
        </div>
    </div>
</div>

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-white shadow-sm rounded-circle p-2 border" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral">
                <i class="bi bi-list fs-4 text-primary"></i>
            </button>
            <div class="rounded-pill shadow-sm px-4 py-2 d-none d-sm-block" style="background-color: #004085; color: white;">
                <small class="fw-bold">ID ESTUDIANTE: </small>
                <span class="ms-1 fw-bold"><%= estudiante.id_estudiante || '001' %></span>
            </div>
        </div>
        <a href="/logout" class="text-danger fw-bold text-decoration-none d-flex align-items-center gap-1 small">
             <i class="bi bi-box-arrow-right fs-5"></i> Salir
        </a>
    </div>

    <div class="mb-4">
        <h2 class="fw-bold mb-1" style="color: #1a3a5a;">
            <% if (saludo.includes('Buenos')) { %> ‚òÄÔ∏è 
            <% } else if (saludo.includes('Tardes')) { %> üå§Ô∏è 
            <% } else { %> üåô <% } %>
            <%= saludo %>, <%= estudiante.nombre %>!
        </h2>
        <p class="text-muted small fw-bold text-uppercase mb-0">
            <i class="bi bi-calendar3 me-1"></i>
            <%= new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }) %>
        </p>
    </div>
    
    <div class="p-4 mb-4 rounded-4 shadow-sm" style="background-color: #f8fbff; border-left: 6px solid #0d6efd; position: relative; overflow: hidden;">
        <div class="d-flex align-items-start gap-3">
            <div class="bg-primary rounded-circle p-2 d-flex align-items-center justify-content-center shadow-sm" style="width: 45px; height: 45px;">
                <i class="bi bi-lightning-charge-fill text-white"></i>
            </div>
            <div>
                <p class="mb-1 fw-bold" style="color: #33475b; font-size: 1.15rem; font-style: italic; line-height: 1.4;">
                    "<%= fraseMotivacional %>"
                </p>
                <small class="text-primary text-uppercase fw-bold" style="letter-spacing: 1px; font-size: 0.75rem;">
                    Inspiraci√≥n para tu √©xito acad√©mico
                </small>
            </div>
        </div>
    </div>

    <% if (notificaciones && notificaciones.length > 0) { %>
        <div class="p-4 mb-4 rounded-4 shadow-sm" style="background-color: #f8f9fa; border-left: 6px solid #6c757d;">
            <h6 class="fw-bold text-dark mb-3">
                <i class="bi bi-bell-fill me-2 text-primary"></i> Notificaciones Prioritarias
            </h6>
            <div class="d-grid gap-2">
                <% notificaciones.forEach(notif => { %>
                    <% 
                        let claseAlerta = 'alert-secondary'; 
                        let icono = 'bi-info-circle-fill';
                        let bordeColor = 'border-secondary';

                        if (notif.tipo === 'examen') { 
                            claseAlerta = 'alert-danger'; 
                            icono = 'bi-exclamation-octagon-fill';
                            bordeColor = 'border-danger';
                        } else if (notif.tipo === 'entrega') { 
                            claseAlerta = 'alert-primary'; 
                            icono = 'bi-file-earmark-arrow-up-fill';
                            bordeColor = 'border-primary';
                        } else if (notif.tipo === 'deberes') { 
                            claseAlerta = 'alert-warning text-dark'; 
                            icono = 'bi-pencil-fill';
                            bordeColor = 'border-warning';
                        }
                    %>
                    <div class="alert <%= claseAlerta %> alert-dismissible fade show p-3 shadow-sm border-start border-4 <%= bordeColor %> mb-0 d-flex align-items-center" role="alert" style="border-radius: 12px;">
                        <i class="bi <%= icono %> me-3 fs-5"></i>
                        <span class="small fw-bold pe-4"><%= notif.texto %></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="font-size: 0.7rem;"></button>
                    </div>
                <% }) %>
            </div>
        </div>
    <% } %>

    <div class="card p-4 shadow-sm border-0 mb-4 bg-white" style="border-radius: 15px;">
        <div class="d-flex justify-content-between mb-2">
            <span class="small fw-bold text-muted">Tu Progreso Semanal</span>
            <span class="small fw-bold text-primary"><%= progreso %>% completado</span>
        </div>
        <div class="progress" style="height: 15px; border-radius: 10px; background-color: #e9ecef;">
            <div id="barraProgreso" class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                 role="progressbar"></div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-white text-center p-4" style="border-radius: 20px; border-top: 5px solid #0dcaf0;">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-patch-check fs-1 text-info mb-3"></i>
                    <h5 class="fw-bold mb-2">Realizar Test</h5>
                    <p class="text-muted small mb-3">Eval√∫a tus conocimientos y define tu m√©todo de estudio.</p>
                    <a href="/estudiantes/mi-perfil/test" class="btn btn-info text-white fw-bold shadow-sm rounded-pill py-2">
                        Ir al Cuestionario
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-white text-center p-4" style="border-radius: 20px; border-top: 5px solid #0d6efd;">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-folder-fill fs-1 text-primary mb-3"></i>
                    <h5 class="fw-bold mb-2">Mi Biblioteca</h5>
                    <p class="text-muted small mb-3">Sube y gestiona tus materiales para usarlos con la IA.</p>
                    <a href="/estudiantes/mi-perfil/misMateriales" class="btn btn-primary fw-bold shadow-sm rounded-pill py-2">
                        Ver Mis Archivos
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-white text-center p-4" style="border-radius: 20px; border-top: 5px solid #6610f2;">
                <div class="card-body d-flex flex-column justify-content-center">
                    <i class="bi bi-robot fs-1 mb-3" style="color: #6610f2;"></i>
                    <h5 class="fw-bold mb-2">Tutor IA</h5>
                    <p class="text-muted small mb-3">Crea recursos educativos guiados por inteligencia artificial.</p>
                    <a href="/estudiantes/mi-perfil/asistente" class="btn fw-bold shadow-sm rounded-pill py-2 text-white" style="background-color: #6610f2;">
                        Comenzar Gu√≠a
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card p-4 shadow-sm border-0 bg-white mb-5" style="border-radius: 15px;">
                <h4 class="fw-bold mb-4 border-bottom pb-2 text-primary"><i class="bi bi-calendar-week me-2"></i>Agenda de Actividades</h4>
                <div id='calendar'></div> 
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="progresoValor" value="<%= progreso %>">
<input type="hidden" id="tareasData" value='<%- JSON.stringify(estudiante.tareas || []) %>'>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. CARGAR BARRA DE PROGRESO
        const progreso = document.getElementById('progresoValor').value;
        const barra = document.getElementById('barraProgreso');
        if (barra) { barra.style.width = progreso + "%"; }

        // 2. CONFIGURAR MAPA DE COLORES CALENDARIO
        const tareas = JSON.parse(document.getElementById('tareasData').value);
        const mapaColores = { 
            'examen': '#dc3545', 
            'entrega': '#0d6efd', 
            'deberes': '#ffc107',
            'aviso': '#6c757d' 
        };

        // 3. INICIALIZAR CALENDARIO
        const calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                events: tareas.map(t => ({
                    id: t._id,
                    title: t.completada ? '‚úÖ ' + t.titulo : t.titulo,
                    // Si es tipo aviso, quitamos la hora del inicio para que no se estire
                    start: t.tipo === 'aviso' ? t.fecha.split('T')[0] : t.fecha.split('T')[0] + 'T' + t.hora,
                    // Marcamos como todo el d√≠a si es un aviso para evitar el solapamiento visual
                    allDay: t.tipo === 'aviso',
                    color: t.completada ? '#28a745' : (mapaColores[t.tipo] || '#6c757d'),
                    extendedProps: { completada: t.completada }
                })),

                dateClick: function(info) {
                    window.location.href = `/estudiantes/mi-perfil/calendario?fecha=${info.dateStr}`;
                },

                eventClick: async function(info) {
                    const comp = info.event.extendedProps.completada;
                    const result = await Swal.fire({
                        title: comp ? '¬øMarcar como pendiente?' : '¬øMarcar como completado?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#0d6efd',
                        confirmButtonText: 'S√≠, cambiar'
                    });
                    
                    if (result.isConfirmed) {
                        const res = await fetch('/estudiantes/toggle-tarea/' + info.event.id, { method: 'PUT' });
                        if ((await res.json()).estado) location.reload();
                    }
                }
            });
            calendar.render();
        }
    });
</script>
<%- include("template/cierre") %>